# VCS

# Authentication vulnerabilities

## Password-based

### Username enumeration via response timing

![image1.png](VCS%203b228/image1.png)

![image2.png](VCS%203b228/image2.png)

![image3.png](VCS%203b228/image3.png)

![image4.png](VCS%203b228/image4.png)

![image5.png](VCS%203b228/image5.png)

### **Username enumeration via account lock**

![image6.png](VCS%203b228/image6.png)

![image7.png](VCS%203b228/image7.png)

![image8.png](VCS%203b228/image8.png)

## Multi-factor

### **2FA simple bypass**

Login vào website bằng username của mình (`wiener`), thấy được path trang chủ là `/my-account`

![Untitled](VCS%203b228/Untitled.png)

Login vào website bằng username `carlos`, khi đến bước nhập mã xác thực, ta chuyển hướng trang đến `/my-account` là truy cập được profile của `carlos`

### **2FA broken logic**

Khi đăng nhập vào website, server sẽ gửi lại cookie `verify` là username cần xác thực bằng code.

![10000201000003CE000001CCC33B33D0C7010A0B.png](VCS%203b228/10000201000003CE000001CCC33B33D0C7010A0B.png)

Do ta không có password của `carlos` để đăng nhập, ta có thể gửi lại request mã xã nhận đến `/login2` để server tạo một mã xác nhận cho user này.

Sau đó dùng `Intruder` để brute-force mã xác thực

![100002010000049000000172F413B2E091B5E616.png](VCS%203b228/100002010000049000000172F413B2E091B5E616.png)

Duy nhất mã xác thực `1630` redirect ta về trang chủ.

![100002010000034E0000026837459640BAB29075.png](VCS%203b228/100002010000034E0000026837459640BAB29075.png)

Mở browser, đăng nhập bằng tài khoản `wiener`, đến bước xác thực ta đổi cookie `verify=carlos` và nhập mã xác thực `1630` là login được bằng tài khoản `carlos`

### 2FA bypass using a brute-force attack

![Untitled](VCS%203b228/Untitled%201.png)

![Untitled](VCS%203b228/Untitled%202.png)

![Untitled](VCS%203b228/Untitled%203.png)

## **Other mechanisms**

### **Password reset broken logic**

Xem request đổi password đến server, ta thấy trong request body có `username=wiener`. Đổi thành `username=carlos`.

![image9.png](VCS%203b228/image9.png)

![image10.png](VCS%203b228/image10.png)

Đăng nhập lại bằng username `carlos` với mật khẩu là mật khẩu ta vừa đổi.

### Brute-forcing a stay-logged-in cookie

Đăng nhập vào website, ta để ý có cookie `stay-logged-in` 

![Untitled](VCS%203b228/Untitled%204.png)

 Sử dụng decode base 64 ta được chuỗi `username:MD5 hash`. Dùng trang [MD5 Decrypt](http://md5decrypt.net/en/) ta ra được `peter` → cookie này bao gồm password được hash MD5

![Untitled](VCS%203b228/Untitled%205.png)

Sử dụng extension Turbor Intruder để brute-force cookie này (theo dạng `carlos:MD5 hashed password`, rồi encode Base 64)

![Untitled](VCS%203b228/Untitled%206.png)

![Untitled](VCS%203b228/Untitled%207.png)

Xem trong responses có 1 response có `Length` dài hơn các response khác. Kiểm tra thì thấy ta đã đăng nhập thành công. Ta có thể dùng [MD5 Decrypt](http://md5decrypt.net/en/) để kiểm tra password đó là gì.

### Offline password cracking

Lab này có liên quan đến lỗi XSS. Nếu ta viết bình luận như hình  vào một post bất kỳ, khi bất kì user nào mở trang đó, họ sẽ bị redirect sang trang `exploit` của academy với path là toàn bộ cookie của website lab

![Untitled](VCS%203b228/Untitled%208.png)

Do đó, khi user `carlos` sau khi xem post này đã bị tự động redirect đi.

![Untitled](VCS%203b228/Untitled%209.png)

Xem log trên trang `exploit` , ta thu được cookie của `carlos`

![Untitled](VCS%203b228/Untitled%2010.png)

Decode Base64 và [MD5 Decrypt](http://md5decrypt.net/en/) ta thu được password.

![Untitled](VCS%203b228/Untitled%2011.png)

![Untitled](VCS%203b228/Untitled%2012.png)

# Access control

## ****Unprotected admin functionality****

Tìm kiếm trang `/robots.txt` , ta có được path đến trang của admin

![Untitled](VCS%203b228/Untitled%2013.png)

![Untitled](VCS%203b228/Untitled%2014.png)

## ****Unprotected admin functionality with unpredictable URL****

Inspect source của website, ta thấy path đến trangcủa admin trong code Javascript

![Untitled](VCS%203b228/Untitled%2015.png)

![Untitled](VCS%203b228/Untitled%2016.png)

## **User role controlled by request parameter**

Lab này sử dụng cookie để kiểm tra xem người dùng có phải admin không. Ta thấy sau khi login, server trả về response có cookie `Admin=false`

![Untitled](VCS%203b228/Untitled%2017.png)

Đổi cookie thành `Admin=true` trên trình duyệt và reload, ta đã trở thành admin và có thể truy cập trang của admin.

![Untitled](VCS%203b228/Untitled%2018.png)

## **User role can be modified in user profile**

Khi thay đổi email, ta thấy server trả về json data có `"roleid"=1` . Theo như mô tả của lab, `"oleid"=2` là của admin.

![Untitled](VCS%203b228/Untitled%2019.png)

Do đó ta gửi lại request đổi email, kèm theo dòng `"roleid"=2` để thử đổi luôn cả `roleid`. Kết quả là ta đổi được `roleid` thật.

![Untitled](VCS%203b228/Untitled%2020.png)

Giờ user `weiner` đã thành admin.

![Untitled](VCS%203b228/Untitled%2021.png)

## **Method-based access control can be circumvented**

Đăng nhập vào account admin được cho trong phần mô tả và nâng user wiener lên admin, ta có thể thấy request sẽ sử dụng phương thức POST đến `/admin-roles` và body là `username=wiener&action=upgrade`. Nếu thành công, server sẽ redirect về `/admin`

![Untitled](VCS%203b228/Untitled%2022.png)

Gửi request vào repeater trong Burpsuit và thay cookie session thành cookie session của normal user (wiener).

![Untitled](VCS%203b228/Untitled%2023.png)

Gửi request lên server, ta nhận code 401.

Ngoài phương thức POST, ta cũng có thể dùng `PUT` để làm điều tương tự. Thử sử dụng phương thức `PUT`, ta nhận được response giống như khi gửi request bằng tài khoản administrator.

Vào lại website để kiểm tra, ta đã được nâng cấp thành admin (lab đã được solved thành công)

![Untitled](VCS%203b228/Untitled%2024.png)

## **URL-based access control can be circumvented**

Gửi request đếnn  `/admin`, ta bị từ chối truy cập

![Untitled](VCS%203b228/Untitled%2025.png)

Theo như mô tả của lab, back-end của server có hỗ trợ header  `X-Original-URL`. Do đó ta thử thêm

`X-Original-URL: /admin` và sửa path thành bất kỳ (khác `/admin`)

![Untitled](VCS%203b228/Untitled%2026.png)

Ta đã truy cập được trang admin

![Untitled](VCS%203b228/Untitled%2027.png)

Bật intercept trong Burpsuit, click Delete user carlos và sử dụng `X-Original-URL: /admin/delete`, ta đã xóa thành công user carlos

![Untitled](VCS%203b228/Untitled%2028.png)

## ****User ID controlled by request parameter****

Truy cập trang chủ, ta để ý trên url parameter có `?id=wiener`, đổi thử thành `?id=carlos`

![Untitled](VCS%203b228/Untitled%2029.png)

Như vậy ta đã truy cập được trang chủ của user `carlos`

![Untitled](VCS%203b228/Untitled%2030.png)

## **User ID controlled by request parameter, with unpredictable user IDs**

Đăng nhập vào website, ta thấy user id lần này có vẻ là chuỗi bất kỳ

![Untitled](VCS%203b228/Untitled%2031.png)

Tìm trong Home có được post được đăng bởi user `carlos`. Bấm vào đó

![Untitled](VCS%203b228/Untitled%2032.png)

Ta có được user id của `carlos` trên URL

![Untitled](VCS%203b228/Untitled%2033.png)

Sử dụng user id đó trên My Account, ta truy cập được profile `carlos` và lấy được API key

![Untitled](VCS%203b228/Untitled%2034.png)

## **User ID controlled by request parameter with data leakage in redirect**

Đăng nhập website bằng username và password của `wiener`, server sẽ trả về trang chủ của `wiener`

![Untitled](VCS%203b228/Untitled%2035.png)

Khi đổi `?id=wiener` thành `?id=carlos` trên browser, ta sẽ bị redirect về trang login. Tuy nhiên nếu ta intercept response của server, ta sẽ thấy server gửi header redirect nhưng vẫn có body.

![Untitled](VCS%203b228/Untitled%2036.png)

Kéo xuống, ta thấy user hiện tại là `carlos` và có được luôn API key.

![Untitled](VCS%203b228/Untitled%2037.png)

## User ID controlled by request parameter with password disclosure

Đăng nhập vào website, đổi `?id=wiener` thành `?id=administrator`

![Untitled](VCS%203b228/Untitled%2038.png)

Truy cập trang của admin thành công. Inspect để xem password của admin

![Untitled](VCS%203b228/Untitled%2039.png)

Dùng password đó để đăng nhập tài khoản admin, xóa user `carlos` để hoàn thành lab.

## Insecure direct object references

Khi vào trang Live chat và ấn View transcript, server sẽ gửi file transcript có tên `2.txt`. Như vậy ta có thể đoán được còn có file transcript tên là `1.txt` trên server.

![Untitled](VCS%203b228/Untitled%2040.png)

Vào Burpsuit và xem `HTTP history` , gửi request tải file transcript vào `Repeater`

![Untitled](VCS%203b228/Untitled%2041.png)

Trong `Repeater`, đổi path `/download-transcript/2.txt` thành `/download-transcript/1.txt`, ta nhận được file transcript chat của user trước đó. Trong file có password của user.

![Untitled](VCS%203b228/Untitled%2042.png)

## **Multi-step process with no access control on one step**

Đăng nhập bằng tài khoản admin cho sẵn trong mô tả và test chức năng nâng quyền user.

![Untitled](VCS%203b228/Untitled%2043.png)

![Untitled](VCS%203b228/Untitled%2044.png)

Cần 2 bước: chọn user để nâng quyền và xác nhận nâng quyền.

Quay vào Burpsuit, mở `HTTP history,`gửi request “chọn user để nâng quyền” và request “xác nhận nâng quyền” vào `Repeater`

![Untitled](VCS%203b228/Untitled%2045.png)

![Untitled](VCS%203b228/Untitled%2046.png)

Logout user `administration` trên browser và login bằng user `wiener` để lấy cookie `session` của user này. Thay cookie `session` trong Repeater bằng cookie vừa lấy được.

Khi gửi request step thứ nhất (chọn user để nâng quyền), ta bị chặn do không có quyền truy cập.

![Untitled](VCS%203b228/Untitled%2047.png)

Nhưng khi gửi request step thứ hai (xác nhận nâng quyền), server đã accept request và nâng quyền cho `wiener`

![Untitled](VCS%203b228/Untitled%2048.png)